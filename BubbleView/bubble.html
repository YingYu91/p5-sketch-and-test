<!-- You must include this JavaScript file -->
<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.10.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>


<script>
	
	/*
BubbleView (http://bubbleview.namwkim.org) is cool, not only because it seems quite usefull (for an overview of more methods see http://turkeyes.mit.edu) but I also like the interface. You can also do some more creative things with it. 

This P5 sketch was made by Maarten Wijntjes, 

*/

let blurim,sharpim,aperture;
let mwidth,mheight;

// radius of the aperture
let radius=50; 
//let data=[];
let trial=0;

let data;

// Everything is scaled to the width you want to present the sketch in. Aspectratios are maintained.
let sketchwidth=600;

let aspectratio,sketchheight;

let clicked=false;

let header=['x','y','r'];

function preload(){
  sharpim=loadImage('https://i.imgur.com/7xM2Mxo.jpg');
 }

function setup() {
  blurim=sharpim.get();
  aspectratio=sharpim.height/sharpim.width
  sketchheight=sketchwidth*aspectratio;
  canvasss=createCanvas(sketchwidth, sketchheight);
  canvasss.parent('brownianDemo');
  sharpim.resize(sketchwidth, sketchheight);
  
  blurim.resize(sketchwidth, sketchheight);
  blurim.filter(BLUR, 10);
  
  aperture=createImage(2*radius,2*radius);
  
  noCursor();
  
  data = new p5.Table();
  for(let i = 0; i<header.length; i++){
    data.addColumn(header[i]);
  }
  
}

function draw() {

  imageMode(CORNER);
  image(blurim,0,0);
  imageMode(CENTER);
  
  if(clicked){
    image(aperture,data.getNum(trial-1, "x"),data.getNum(trial-1, "y"));
  }
  
  noFill();
  stroke(255,0,0);
  ellipse(mouseX,mouseY,2*radius,2*radius);
  //text(clicked,30,30);
}


function mouseClicked(){
  trial++
  sharpim.loadPixels();
  aperture.loadPixels();
  let c;
  
  for (let i = 0; i < aperture.width; i++) {
    for (let j = 0; j < aperture.height; j++) {
      if(dist(i, j, aperture.width/2, aperture.height/2)<aperture.width/2){
        c=sharpim.get(mouseX+i-aperture.width/2,mouseY+j-aperture.height/2);
        aperture.set(i, j, c);
    }else{
      aperture.set(i, j, color(0, 0, 0, 0));
    }
    }
  }
  aperture.updatePixels();
  
  let newRow = data.addRow();
  newRow.setNum('x', int(mouseX));
  newRow.setNum('y', int(mouseY));
  newRow.setNum('r', radius);
  
  if(clicked){
    clicked=true;
  }else{
    clicked=true;
  }
}

function keyPressed() {
  if (keyCode === ENTER) {
    clicked=false;
    //saveTable(data, 'new.csv');
    expout = document.getElementById('expout');
    expout.value=table2csv();
    
  } 
}

function table2csv(){
  let outstrheader=join(header, ',');
  
  let nrows=data.getRowCount();
  let ncols=header.length;

  let outstr=[];
  for(let j=0; j<nrows; j++){
    let tempArray=[];
    for(let i=0; i<ncols; i++){
      tempArray[i]=data.get(j,i);
    }
    outstr[j]=join(tempArray,','); 
  }
  return outstrheader+'\n'+join(outstr,'\n');


}


</script>
    
<crowd-form answer-format="flatten-objects">

    <p style="font-size:30px">
        Click on some parts of this image to find out what it is, 
    press ENTER/RETURN key on your kerybord and then when finish by pressing submit</p>
    
    <br>
        <div id="brownianDemo"></div>
    <br>
    <crowd-input hidden name="dataoutput" id="expout" placeholder=" " required></crowd-input>

</crowd-form>
